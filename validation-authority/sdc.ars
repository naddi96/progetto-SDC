
define set utenti_loggati = { };

define urlset url_login_set = { /login };

define set insieme1 = { };
define set insieme2 = { };



define urlset area_nord = { /regione/Veneto/*/*/*,/regione/Lombardia/*/*/* };

define urlset area_sud = { /regione/Sicilia/*/*/*,/regione/Campania/*/*/* };

define urlset area_centro = { /regione/Lazio/*/*/* , /regione/Abruzzo/*/*/* };

(*
define urlset admin_nazionale = { /regione/Lazio/* , /regione/Abruzzo/* , /regione/Molise/*, /regione/Sicilia/*,/regione/Campania/*,/regione/Piemenonte/*,/regione/Lombardia/* };
*)

define urlset admin_nazionale ={ /regione/*/*/*/*/* };




define urlset Campania = { /regione/Campania/*/*/* };
define urlset Sicilia = { /regione/Sicilia/*/*/* };

define urlset Veneto = { /regione/Veneto/*/*/* };
define urlset Lombardia = { /regione/Lombardia/*/*/* };


define urlset Lazio = { /regione/Lazio/*/*/* };
define urlset Abruzzo = { /regione/Abruzzo/*/*/* };

define urlset tutti_dati = { /regione/*/dati/* };


define urlset login_page = { /login/*/*/* };

define urlset login_Admin_post = { /login/admin };


define set session_admin = { };


define set session_area_nord = { };
define set session_area_sud = { };
define set session_area_centro = { };


define set session_Sicilia = { };
define set session_Campania = { };
define set session_Lazio = { };
define set session_Abruzzo = { };
define set session_Piemonte = { };
define set session_Lombardia = { };


define set pubblica_dati = { };
define urlset PubblicaDati = { /PubblicaDati };



(*/protezione bruteforce*)
define urlset login_post = { /login/admin, /login/regione, /login/area };
define set livello1 = { };
define set livello2 = { };
define set livello3 = { };
define set livello4 = { };
define set livello5 = { };

define set regioni_interdette = { };

define AR "blocca ip"
       CONDITION
              net.ipsrc is in livello5 ":.*$" ""
       ACTION
              answer "ip stato bloccato"
;
(*protezione bruteforce/*)



(*pagina richiesta spostamento*)
define urlset sposta_url={ /richiesta/richiestaSpostamento.html };
DEFINE AR "serve richiesta spostamento"
	CONDITION
		http.url is in sposta_url
	ACTION
		answer "./richiestaSpostamento.html"
	;

define urlset sposta_post_url = { /richiestaSpostamento };
DEFINE AR "richiesta spostamento SI"
	CONDITION
		http.url is in sposta_post_url
              not http.data["regione1"] is in regioni_interdette
              not http.data["regione2"] is in regioni_interdette
	ACTION
		answer "./spostamentoAutorizzato.html"
	;
DEFINE AR "richiesta spostamento NO regione1"
	CONDITION
		http.url is in sposta_post_url
              http.data["regione1"] is in regioni_interdette
	ACTION
		answer "./spostatamentoNonAutorizzato.html"
       ;
DEFINE AR "richiesta spostamento NO regione2"
       CONDITION
              http.url is in sposta_post_url
              http.data["regione2"] is in regioni_interdette
	ACTION
		answer "./spostatamentoNonAutorizzato.html"
       ;

DEFINE VR "memorizza richiesta spostatamento"
	CONDITION
		http.url is in sposta_post_url
              not http.data["regione1"] is in regioni_interdette
              not http.data["regione2"] is in regioni_interdette
	ACTION
              mysql.append("127.0.0.1:3306","vadb","root","root",
              "insert into richiestespo (codicefiscale,partenza,arrivo,esito) values ($0,$1,$2)",
              {http.data["codicefiscale"],http.data["regione1"],http.data["regione2"],"AFFERMATIVO"})
       OR
       	http.url is in sposta_post_url
              http.data["regione1"] is in regioni_interdette
       ACTION
              mysql.append("127.0.0.1:3306","vadb","root","root",
              "insert into richiestespo (codicefiscale,partenza,arrivo,esito) values ($0,$1,$2)",
              {http.data["codicefiscale"],http.data["regione1"],http.data["regione2"],"NEGATIVO"})
       OR
              http.url is in sposta_post_url
              http.data["regione2"] is in regioni_interdette
	ACTION
              mysql.append("127.0.0.1:3306","vadb","root","root",
              "insert into richiestespo (codicefiscale,partenza,arrivo,esito) values ($0,$1,$2)",
              {http.data["codicefiscale"],http.data["regione1"],http.data["regione2"],"NEGATIVO"})
       ;



(*pagina repilogo allert*)
define urlset allert_html={ /regione/alert.html };
DEFINE AR "allert html"
	CONDITION
		http.url is in allert_html
              http.cookie['admin'] is in session_admin
	ACTION
		answer "./alert.html"
	;


define urlset allert_page={ /alert };
DEFINE AR "allert page"
	CONDITION
              http.cookie['admin'] is in session_admin
		http.url is in allert_page

	ACTION
		MANAGE "alerts"
	;
(*pagina repilogo allert*)


(*rendi dati pubblici*)
define AR "passa i dati se resi pubblici"
       CONDITION
              http.url is in tutti_dati
              CAT{"1234"} is in pubblica_dati
       ACTION
              tcp.redirect "127.0.0.1:5001"
;

define AR "pubblica dati"
       CONDITION
              http.url is in PubblicaDati
              http.cookie['admin'] is in session_admin
       ACTION
              answer "Hai reso pubblici i dati"
;


define VR "pubblica dati VR"
(*aggiungiamo 1234 all insieme per rendere i dati pubblici per un ora*)
       CONDITION
              http.url is in PubblicaDati
              http.cookie['admin'] is in session_admin
       ACTION

              add "1234" to set pubblica_dati 3600
       ;

(*rendi dati pubblici end*)



(*accesso login admin*)
define AR "passa login page"
    CONDITION
        http.url is in login_page
    ACTION
        tcp.redirect "127.0.0.1:5000"
;

define AR "passa admin"
    CONDITION
        http.url is in admin_nazionale
        http.cookie['admin'] is in session_admin
    ACTION
        tcp.redirect "127.0.0.1:5001"
;

DEFINE VR "verifica login admin nazionale"
       CONDITION
              obs.event is net.send
              http.url is in login_Admin_post
       VAR
              sessione = net.sesid
              utente = http.data["username"]
       ACTION
              report login {http.uri, http.data["username"]}
       NEXT (
              exists http.answer.cookie["admin"]
              obs.event is net.recv
              net.sesid is sessione
       ACTION
              report login {cat {"il login di ", utente, " è stato completato con successo", http.answer.cookie["admin"]}}
              add http.answer.cookie["admin"] to set session_admin ";.*$" ""
       OR
              not exists http.answer.cookie["admin"]
              obs.event is net.recv
              net.sesid is sessione
       ACTION
              report login {cat {"il login di ", utente, " non è stato completato con successo"}}
       )
;
(*accesso login admin*)



(*valori critici va admin nazionale*)
define set valori_critici = { "50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100" };
define urlset admin_nazionale_submit = { /regione/submit/* };
DEFINE VR "verifica e memorizza livello di criticita"
       CONDITION
              http.cookie['admin'] is in session_admin
              http.url is in admin_nazionale_submit
              http.data["percentuale"] is in valori_critici
       ACTION
              mysql.append("127.0.0.1:3306","vadb","root","root",
              "insert into vatable (regione,percentuale) values ($0,$1)",
              {http.url,http.data["percentuale"]})
              add http.uri to set regioni_interdette 259200 "/regione/submit/" ""
;


(*/protezione bruteforce*)
define VR "login bruteforce livello5 blocco ip"
       CONDITION
              http.url is in login_post
              not exists http.answer.cookie["admin"]
              CAT{net.ipsrc":.*$" ""} is in livello4
       ACTION
              add net.ipsrc to set livello5  ":.*$" ""
       OR
              http.url is in login_post
              not exists http.answer.cookie["regione"]
              CAT{net.ipsrc":.*$" ""} is in livello4
       ACTION
              add net.ipsrc to set livello5 ":.*$" ""
       OR
              http.url is in login_post
              not exists http.answer.cookie["area"]
              CAT{net.ipsrc":.*$" ""} is in  livello4
       ACTION
              add net.ipsrc to set livello5 ":.*$" ""
;


define VR "login bruteforce livello4"
       CONDITION
              http.url is in login_post
              not exists http.answer.cookie["admin"]
              CAT{net.ipsrc":.*$" ""} is in livello3
       ACTION
              add net.ipsrc to set livello4 10 ":.*$" ""
       OR
              http.url is in login_post
              not exists http.answer.cookie["regione"]
              CAT{net.ipsrc":.*$" ""} is in livello3
       ACTION
              add net.ipsrc to set livello4 10 ":.*$" ""
       OR
              http.url is in login_post
              not exists http.answer.cookie["area"]
              CAT{net.ipsrc":.*$" ""} is in livello3
       ACTION
              add net.ipsrc to set livello4 10 ":.*$" ""
;

define VR "login bruteforce livello3"
       CONDITION
              http.url is in login_post
              not exists http.answer.cookie["admin"]
              CAT{net.ipsrc":.*$" ""} is in livello2
       ACTION
              add net.ipsrc to set livello3 10 ":.*$" ""
       OR
              http.url is in login_post
              not exists http.answer.cookie["regione"]
              CAT{net.ipsrc":.*$" ""} is in livello2
       ACTION
              add net.ipsrc to set livello3 10 ":.*$" ""
       OR
              http.url is in login_post
              not exists http.answer.cookie["area"]
              CAT{net.ipsrc":.*$" ""} is in livello2
       ACTION
              add net.ipsrc to set livello3 10 ":.*$" ""
;


define VR "login bruteforce livello2"
       CONDITION
              http.url is in login_post
              not exists http.answer.cookie["admin"]
              CAT{net.ipsrc":.*$" ""} is in livello1
       ACTION
              add net.ipsrc to set livello2 10 ":.*$" ""
       OR
              http.url is in login_post
              not exists http.answer.cookie["regione"]
              CAT{net.ipsrc":.*$" ""} is in livello1
       ACTION
              add net.ipsrc to set livello2 10 ":.*$" ""
       OR
              http.url is in login_post
              not exists http.answer.cookie["area"]
              CAT{net.ipsrc":.*$" ""} is in livello1
       ACTION
              add net.ipsrc to set livello2 10 ":.*$" ""
;

define VR "login bruteforce livello1"

       CONDITION
              http.url is in login_post
              not exists http.answer.cookie["admin"]
       ACTION
              add net.ipsrc to set livello1 10 ":.*$" ""
       OR
              http.url is in login_post
              not exists http.answer.cookie["regione"]
       ACTION
              add net.ipsrc to set livello1 10 ":.*$" ""
       OR
              http.url is in login_post
              not exists http.answer.cookie["area"]
       ACTION
              add net.ipsrc to set livello1 10 ":.*$" ""

;
(*protezione bruteforce/*)
